# Домашняя работа по занятию "5.2. Системы управления виртуализацией"

> 1. Выберете подходящую систему управления виртуализацией для предложенного сценария. Детально опишите ваш выбор. Сценарии:

> - 100 виртуальных машин на базе Linux и Windows, общие задачи, нет особых требований  
> Преимущественно Windows based инфраструктура, требуется реализация программных балансировщиков нагрузки, репликации данных и автоматизированного механизма создания резервных копий

Я бы vSphere взял. 100 виртуалок предполагают собой уже какой-то кластер, лучше с HA, и скорее всего vApp всякие с контролем и приоритезацией ресуров.
Для балансировки нагрузки там DRS, репликация данных тоже есть, было бы куда и что реплицировать. В рамках Site Recovery, например. 
Для автоматизации там есть PowerCLI/PowerShell, можно накодить любую логику. 
С бакапчиками вот беда, обычно сторонний Veeam берут. Но если общий сторадж на NFS, наверное можно что-нибудь своё наколхозить, если сможем прочесть залоченный файл диска работающей виртуалки.

Хотя возможно "Преимущественно Windows based инфраструктура" намекает, что нужно брать Hyper-V, но я Сферу лучше знаю, возьму её :)
  
> - Требуется наиболее производительное бесплатное opensource решение для виртуализации небольшой (20 серверов) инфраструктуры Linux и Windows виртуальных машин
  
Proxmox пожалуй что. Может, oVirt. Возможно, "наиболее производительное" намекает на паравиртуализацию, тогда можно и XEN. Под Виндусом правда только драйвера паравиртуализированные будут, 
а такие и у KVM есть...

> - Необходимо бесплатное, максимально совместимое и производительное решение для виртуализации Windows инфраструктуры

В конторе с лицензиями на кучу DataCenter Server его Hyper-V вроде уже бесплатный будет? Максимально совместимо с Windows.   
Если это вся эта инфраструктура в рамках одного сервера умещается, то можно взять ESXi, как standalone он бесплатный. Или тоже бесплатный Hyper-V Server, опять же, для максимальной совместимости.    
А так, из бесплатного, наверное kvm с какой-нибудь управлялкой в зависимости от масштаба инфраструктуры.

> - Необходимо рабочее окружение для тестирование программного продукта на нескольких дистрибутивах Linux

Контейнеры. Или kvm/virtmanager/vagrant. Или Virtualbox.

---
> 2. Опишите сценарий миграции с VMware vSphere на Hyper-V для Linux и Windows виртуальных машин. Детально опишите необходимые шаги для использования всех преимуществ Hyper-V для Windows.

Для подобной миграции рекомендуют использовать Microsoft Virtual Machine Converter (MVMC). 
Парочку VM можно смигрировать вручную, старательно и правильно нажимая кнопочки в интерфейсе программы и вводя данные для подключения к Сфере и Hyper-V. 

Если виртуалок больше, имеет смысл автоматизировать этот процесс с помощью PowerShell-скрипта. Hyper-V предоставляет командлеты для создания 
и настройки VM, MVMC предосталяет командлет для конвертации образа диска виртуалки из VMDK в VHD, PowerCli предоставляет командлеты 
для взаимодействия с Сферой. 

Для каждой мигрируемой VM по списку нам будет нужно:
- подключившись к Сфере, узнать параметры VM - количество CPU, памяти, сетевых интерфейсов, их VLANы, MAC-адреса, и т.д. (Get-VM из PowerCli)
- выполнить предварительный провизионинг внутри виртуалок: почистить диски от ненужного, удалить vmware tools, для Windows вызвать sysprep,
для Линуксов создать новый initrd с включением модулей ядра для железа Hyper-V (Invoke-VMScript из PowerCli, или напрямую SSH/WinRM);
- удалить снапшоты (Get-VM |Get-Snapshot |Remove-Snapshot);
- удалить виртуалки из vSphere inventory, не стирая их при этом с диска (Remove-VM без -DeletePermanently);
- скопировать себе диски виртуалкок (или с общего NFS-стораджа, или подключившись напрямую к ESXi по scp);
- сконвертировать образ диска виртуалки, воспользовавшись командлетом ConvertTo-MvmcVirtualHardDisk из поставки MVMC;
- создать новую VM, с необходимыми ресурсами (которые мы узнали в первом пункте), подключив к ней уже существующий свежеконвертированный 
  образ диска (New-VM ... -VHDPath ...)
  
Разумеется, это всё придётся отдебажить и разобраться с подводными камушками. 


---
> 3. Опишите возможные проблемы и недостатки гетерогенной среды виртуализации (использования нескольких систем управления виртуализацией одновременно)

- конфликты между системами виртуализации. Так, в рамках одного хоста VirtBox и KVM передерутся между собой из-за загруженных модулей ядра.
- увеличенный/неоптимальный расход ресурсов - каждой системе предоставь свои сервера, хранилки.
- необходимость в большем штате специализированных инженеров, или более дорогих универсальных инженерах.
- потенциально неоптимальное лицензирование, можно не получить бонусов из-за больших объёмов (VM, CPU - что там лицензируется), которые будут
  раздроблены между несколькими системами виртуализации.
- невозможность лёгкой миграции VM между разными системами. 
- Меньше шансов и ресурсов для построения отказоустойчивых решений. (может не набраться нужное количество серверов, или shared LUNs)  

> и что необходимо сделать для минимизации этих рисков и проблем.

Унифицировать используемые решения :) 

> Если бы у вас был бы выбор, то создавали ли вы бы гетерогенную среду или нет? Мотивируйте ваш ответ примерами.

Так это в зависимости от обстоятельств.

Возможно, нам необходима поддержка какой-то фичи, которая отсутствует в нашей основной системе виртуализации. Например, каким-то хитрым
Windows вынь да подай Hyper-V, а то тормозить будут. Или мы для стремительности разработки и тестирования хотим использовать фичу KVM 
напрямую грузить kernel/initrd для Linux-машин, без всего этого BIOS/MBR.

Возможно, нам это будет выгодно с точки зрения лицензирования. Вот есть у нас vSphere-лицензия на 20CPU, а расширять мы её не хотим - 
либо лицензия, либо зарплата. Тогда можно выселить часть виртуалок на Proxmox какой-нибудь.  

Но в идеале конечно использовать унифицированное решение и не распылять силы и ресурсы.
