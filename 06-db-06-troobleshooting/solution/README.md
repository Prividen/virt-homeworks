# Домашнее работа по занятию "6.6. Troubleshooting"

> 1. Пользователь (разработчик) написал в канал поддержки, что у него уже 3 минуты происходит CRUD операция в MongoDB и её 
нужно прервать. 
> - напишите список операций, которые вы будете производить для остановки запроса пользователя

Нужно узнать `opid` этого запроса через `db.currentOp()`, и убить его с помощью `db.killOp(opid)`

> - предложите вариант решения проблемы с долгими (зависающими) запросами в MongoDB

Попытаться сделать, чтобы таких зависающих запросов не было - поставить и настроить монгу согласно лучшим рекомендациям, выделить адекватное количество ресурсов. Если зависающий запрос случается, нужно попробовать понять, почему он зависающий с помощью .explain(), и чинить соответственно.

---

> 2. Вы запустили инстанс Redis для использования совместно с сервисом, который использует механизм TTL. 
Причем отношение количества записанных key-value значений к количеству истёкших значений есть величина постоянная и
увеличивается пропорционально количеству реплик сервиса.  
При масштабировании сервиса до N реплик вы увидели, что:
> - сначала рост отношения записанных значений к истекшим
> - Redis блокирует операции записи  
> Как вы думаете, в чем может быть проблема?

Возможно, слишком много ключей проэкспирилось единовременно, процесс очистки обнаружил, что таких ключей больше 25% от общего количества, и зациклился, пытаясь их очистить.

---
> 3. Вы подняли базу данных MySQL для использования в гис-системе. При росте количества записей, в таблицах базы,
пользователи начали жаловаться на ошибки вида: `InterfaceError: (InterfaceError) 2013: Lost connection to MySQL server during query u'SELECT..... '`  
Как вы думаете, почему это начало происходить и как локализовать проблему?  

Наверное, наша гис-система принялась возвращать по много строк на запрос, и они не успевают отдаться клиенту за отведённый таймаут. Надо посмотреть explain запроса, чего там творится, и заглянуть в логи. Возможно, помониторить сетевые подключения.

> Какие пути решения данной проблемы вы можете предложить?

Можно попробовать увеличить параметр `net_write_timeout`. Или оптимизировать приложение, чтобы запросы были поскромнее.

---

> 4. Вы решили перевести гис-систему из задачи 3 на PostgreSQL, так как прочитали в документации, что эта СУБД работает с 
большим объемом данных лучше, чем MySQL.
После запуска пользователи начали жаловаться, что СУБД время от времени становится недоступной. В dmesg вы видите, что:
`postmaster invoked oom-killer`  
Как вы думаете, что происходит?

Постгрес запросил у системы больше памяти, чем у неё есть. Система решила прибить какой-нибудь процесс, 
чтобы памяти хватило. Возможно даже сам postgres, раз он время от времени становится недоступным.

> Как бы вы решили данную проблему?

Можно попробовать раздобыть системе побольше памяти, или подкрутить oom_score у postgres (чтобы умирал кто-то другой), или умерить аппетиты самого постгреса - уменьшить значения параметров вроде shared_buffers, effective_cache_size, etc.
